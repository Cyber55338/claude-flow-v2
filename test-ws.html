<!DOCTYPE html>
<html>
<head><title>WebSocket Test</title></head>
<body>
    <h1>WebSocket Connection Test</h1>
    <pre id="log"></pre>

    <script>
        const log = document.getElementById('log');

        function addLog(msg) {
            log.textContent += msg + '\n';
            console.log(msg);
        }

        addLog('Testing WebSocket connection...\n');
        addLog('Host: ' + window.location.host);
        addLog('Protocol: ' + window.location.protocol);

        const wsUrl = 'ws://' + window.location.host;
        addLog('WebSocket URL: ' + wsUrl + '\n');

        try {
            addLog('Creating WebSocket...');
            const ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                addLog('‚úÖ CONNECTED!');
                addLog('ReadyState: ' + ws.readyState);

                // Send a test message
                addLog('\nSending subscribe message...');
                ws.send(JSON.stringify({ type: 'subscribe' }));
            };

            ws.onmessage = (event) => {
                addLog('üì• Received: ' + event.data);
            };

            ws.onerror = (error) => {
                addLog('‚ùå ERROR: ' + error);
                addLog('Error type: ' + error.type);
                addLog('Error message: ' + error.message);
            };

            ws.onclose = (event) => {
                addLog('‚ùå CLOSED');
                addLog('Code: ' + event.code);
                addLog('Reason: ' + event.reason);
                addLog('Clean: ' + event.wasClean);
            };

            // Timeout check
            setTimeout(() => {
                addLog('\nAfter 3 seconds:');
                addLog('ReadyState: ' + ws.readyState + ' (0=CONNECTING, 1=OPEN, 2=CLOSING, 3=CLOSED)');

                if (ws.readyState !== 1) {
                    addLog('\n‚ùå WebSocket failed to connect!');
                    addLog('This is why canvas updates don\'t work.');
                }
            }, 3000);

        } catch (error) {
            addLog('‚ùå EXCEPTION: ' + error.message);
            addLog('Stack: ' + error.stack);
        }
    </script>
</body>
</html>
